<!-- templates/base.html -->
{% extends 'base.html' %}

{% load static %}

{% block page_title %}
MIT - Lista Veicoli Cude - OpenMSP - Multi Services Portal
{% endblock %}

{% block centered_container %}
<h3>MIT - Ministero delle infrastrutture e dei trasporti</h3>
<h4>Lista Veicoli Cude</h4>
<br />
{% if user.is_authenticated %}
{% if utente_abilitato %}

<div class="col-8 shadow-lg white-bg p-4">
  <div class="row border border-secondary rounded p-3 m-3 pt-4 shadow-lg">
    <form class="needs-validation" id="mit_lista_veicoli" method="post">
      {% csrf_token %}
      <div class="form-group mb-3">
        <label for="dataFineValiditaDal">Data fine validita dal (opzionale)</label>
        <input type="datetime-local" class="form-control" id="dataFineValiditaDal" name="dataFineValiditaDal" />
      </div>
      <div class="form-group mb-3">
        <label for="dataFineValiditaAl">Data fine validita al (opzionale)</label>
        <input type="datetime-local" class="form-control" id="dataFineValiditaAl" name="dataFineValiditaAl" />
      </div>
      <div class="col-3">
        <button class="btn btn-primary" type="submit">
          <svg class="icon icon-sm icon-white" aria-hidden="true">
            <use href="{% static 'svg/sprites.svg' %}#it-search"></use>
          </svg>Avvia ricerca
        </button>
      </div>
    </form>
    <div class="row">
      <div aria-live="polite" id="errorMsgContainer"></div>
    </div>
  </div>
</div>
<br>

{% if response_data %}
<div class="col-10 mb-4">
  <article class="it-card it-card-height-full rounded shadow-lg border">
    <div class="it-card-body">
      <h5 class="it-card-title">Esito richiesta Lista Veicoli</h5>
      {% if http_status %}
      <p class="it-card-text">HTTP status: <b>{{ http_status }}</b></p>
      {% endif %}
      {% if query_params %}
      <p class="it-card-text">
        Filtri applicati:
        <b>
          {% for k, v in query_params.items %}
          {{ k }}={{ v }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </b>
      </p>
      {% endif %}
      {% if response_data.esito %}
      <p class="it-card-text">
        Codice esito: <b>{{ response_data.esito.codice|default:"-" }}</b><br>
        Descrizione esito: <b>{{ response_data.esito.descrizione|default:"-" }}</b>
      </p>
      {% endif %}
      <h6>Risultato</h6>
      <pre id="json-display" class="bg-light p-3 rounded border"></pre>
      {{ response_data|json_script:"lista-veicoli-json" }}
    </div>
  </article>
</div>
{% endif %}

{% else %}
<div class="col-6">
  <h4>Utente non abilitato</h4>
  <p>L'utente non Ã¨ abilitato all'utilizzo di questo servizio</p>
  <p>Per maggiori informazioni contatti l'amministratore del portale</p>
  <div class="p-3 text-end">
    <a href="{% url 'home' %}" class="btn btn-danger">Torna indietro</a>
  </div></div>
  {% endif %}

  {% else %}
  <h4>Utente non loggato</h4>
  <p>Per poter effettuare le consultazioni alle banche dati, devi loggarti al portale</p>
  <a href="{% url 'login' %}" class="btn btn-primary">
    <svg class="icon icon-sm icon-white" aria-hidden="true">
      <use href="{% static 'svg/sprites.svg' %}#it-user"></use>
    </svg>Accedi
  </a>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const jsonNode = document.getElementById('lista-veicoli-json')
      const output = document.getElementById('json-display')
      if (jsonNode && output) {
        const parsed = JSON.parse(jsonNode.textContent)
        output.textContent = JSON.stringify(parsed.risultato ?? parsed, null, 2)
      }
    })
  </script>
  {% endblock %}

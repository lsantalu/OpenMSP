<!-- templates/base.html -->
{% extends 'base.html' %}

{% load static %}

{% block page_title %}
MIT - Verifica Targa Cude - OpenMSP - Multi Services Portal
{% endblock %}

{% block centered_container %}
<h3>MIT - Ministero delle infrastrutture e dei trasporti</h3>
<h4>Verifica Targa Cude</h4>
<br />
{% if user.is_authenticated %}
{% if utente_abilitato %}

<div class="col-8 shadow-lg white-bg p-4">
  <div class="row border border-secondary rounded p-3 m-3 pt-4 shadow-lg">
    <form class="needs-validation" id="mit_verifica_targa" method="post">
      {% csrf_token %}
      <div class="form-group">
        <label for="input_targa">Inserisci targa del veicolo</label>
        <input type="text" class="form-control" id="input_targa" name="input_targa" maxlength="7" oninput="this.value = this.value.toUpperCase();" required />
      </div>
      <div class="col-3">
        <button class="btn btn-primary" type="submit">
          <svg class="icon icon-sm icon-white" aria-hidden="true">
            <use href="{% static 'svg/sprites.svg' %}#it-search"></use>
          </svg>Avvia ricerca
        </button>
      </div>
    </form>
    <div class="row">
      <div aria-live="polite" id="errorMsgContainer"></div>
    </div>
  </div>
  <br>

  {% if data %}
  <div class="col-8 mb-4">
    <article class="it-card it-card-image it-card-height-full rounded shadow-lg border">
      <h5 class="it-card-title it-card-title-icon">Esito Verifica per Targa: {{ data.0 }}</h5>
      
      {% if data.1.esito.codice != "OK" and data.1.esito.codice != "00" %}
      <div class="it-card-image-wrapper bg-danger p-3" style="--bs-bg-opacity: .75;">
        <span class="text-white">Errore: {{ data.1.esito.codice }}</span>
      </div>
      {% else %}
      <div class="it-card-image-wrapper bg-success p-3" style="--bs-bg-opacity: .75;">
        <span class="text-white">Verifica Completata</span>
      </div>
      {% endif %}

      <div class="it-card-body">
        <p class="it-card-text">
          Esito: <b>{{ data.1.esito.descrizione }}</b><br>
          Codice: <b>{{ data.1.esito.codice }}</b>
        </p>

        {% if data.1.risultato %}
        <hr>
        <h6>Dettaglio Risultato:</h6>
        <div class="alert alert-info">
          <pre>{{ data.1.risultato|json_script:"risultato-data" }}</pre>
          <div id="risultato-display"></div>
        </div>
        {% endif %}
      </div>
    </article>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const dataNode = document.getElementById('risultato-data');
      if (dataNode) {
        const res = JSON.parse(dataNode.textContent);
        const display = document.getElementById('risultato-display');
        display.innerHTML = '<ul class="list-unstyled">';
        for (const [key, value] of Object.entries(res)) {
          display.innerHTML += `<li>${key}: <strong>${value}</strong></li>`;
        }
        display.innerHTML += '</ul>';
      }
    });
  </script>

  <br>
  <div class="row">
    <div class="col-6 mb-4">
      <button id="printButton" class="btn btn-secondary" onclick="window.print()">
        <svg class="icon icon-sm icon-white" aria-hidden="true">
          <use href="{% static 'svg/sprites.svg' %}#it-print"></use>
        </svg> Stampa ricerca
      </button>
    </div>
  </div>

  {% if user.is_superuser %}
  <div class="col-10 shadow-lg white-bg">
    <div class="accordion p-3 accordion-background-active" id="accordionExampleHa">
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse" aria-expanded="false" aria-controls="collapse">Dettaglio JSON Interrogazione (Debug)
          </button>
        </h2>
        <div id="collapse" class="accordion-collapse collapse" data-bs-parent="#accordionExampleHa" role="region" aria-labelledby="heading">
          <div class="accordion-body">
            <div class="link-list-wrapper">
              <pre id="json-display">{{ data.1|json_script:"full-json" }}</pre>
              <div id="full-json-pretty"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const fullJsonNode = document.getElementById('full-json');
      if (fullJsonNode) {
        const fullJson = JSON.parse(fullJsonNode.textContent);
        document.getElementById('full-json-pretty').textContent = JSON.stringify(fullJson, null, 2);
      }
    });
  </script>
  {% endif %}

</div>
{% endif %}

{% else %}
<div class="col-6">
  <h4>Utente non abilitato</h4>
  <p>L'utente non è abilitato all'utilizzo di questo servizio</p>
  <p>Per maggiori informazioni contatti l'amministratore del portale</p>
  <div class="p-3 text-end">
    <a href="{% url 'home' %}" class="btn btn-danger">Torna indietro</a>
  </div></div>
  {% endif %}

  {% else %}
  <h4>Utente non loggato</h4>
  <p>Per poter effettuare le consultazioni alle banche dati, devi loggarti al portale</p>
  <a href="{% url 'login' %}" class="btn btn-primary">
    <svg class="icon icon-sm icon-white" aria-hidden="true">
      <use href="{% static 'svg/sprites.svg' %}#it-user"></use>
    </svg>Accedi
  </a>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const errorMessage = '<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Attenzione</strong> Il campo "Targa" è da controllare.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi avviso">'
      const errorWrapper = document.querySelector('#errorMsgContainer')
      const validate = new bootstrap.FormValidate('#mit_verifica_targa', {
        errorFieldCssClass: 'is-invalid',
        errorLabelCssClass: 'form-feedback',
        errorLabelStyle: '',
        focusInvalidField: false
      })
      validate
      .addField('#input_targa', [
      {
        rule: 'required',
        errorMessage: 'Questo campo è richiesto'
      },
      {
        rule: 'minLength',
        value: 7,
        errorMessage: 'La targa deve avere il formato AA111AA'
      },
      {
        rule: 'maxLength',
        value: 7,
        errorMessage: 'La targa deve avere il formato AA111AA'
      },
      {
        rule: 'customRegexp',
        value: '^[A-Z]{2}[0-9]{3}[A-Z]{2}$',
        errorMessage: 'La targa non è scritta correttamente'
      }
      ])
      .onSuccess(() => {
        document.forms['mit_verifica_targa'].submit()
      })
      .onFail((fields) => {
        errorWrapper.innerHTML = ''
        errorWrapper.innerHTML = errorMessage
      })
    })
  </script>
  {% endblock %}
